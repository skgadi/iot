<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>IOT configurator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!--Faveicon handling-->
  <link rel="apple-touch-icon" sizes="57x57" href="apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192" href="android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
  <link rel="manifest" href="manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">

  <!--CSS help-->
  <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
  <link rel="stylesheet" href="https://www.w3schools.com/lib/w3-theme-indigo.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.css"
    integrity="sha256-46qynGAkLSFpVbEBog43gvNhfrOj+BmwXdxFgVK/Kvc=" crossorigin="anonymous" />
  <link rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/github-fork-ribbon-css/0.2.3/gh-fork-ribbon.min.css" />
  <!--Redirect to a correct page-->

  <style>
    .smallIconButton {
      padding: 0px;
      height: 40px;
    }

    .w3-input {
      outline-width: 0;
    }

    input[type="color"] {
      -webkit-appearance: none;
      border: none;
    }

    input[type="color"]::-webkit-color-swatch-wrapper {
      padding: 0;
    }

    input[type="color"]::-webkit-color-swatch {
      border: none;
    }

    .centerTable>table {
      margin: auto !important;
    }
  </style>
  <style>
    /*Spinner from https://loading.io/css/ */
    .lds-ripple {
      display: inline-block;
      position: relative;
      width: 64px;
      height: 64px;
    }

    .lds-ripple div {
      position: absolute;
      border: 4px solid rgb(161, 19, 154);
      opacity: 1;
      border-radius: 50%;
      animation: lds-ripple 1.5s cubic-bezier(0, 0.2, 0.8, 1) infinite;
    }

    .lds-ripple div:nth-child(2) {
      animation-delay: -0.5s;
    }

    @keyframes lds-ripple {
      0% {
        top: 28px;
        left: 28px;
        width: 0;
        height: 0;
        opacity: 1;
      }

      100% {
        top: -1px;
        left: -1px;
        width: 58px;
        height: 58px;
        opacity: 0;
      }
    }
  </style>
</head>

<body style="background: lightgoldenrodyellow;">
  <a class="github-fork-ribbon" href="https://github.com/skgadi/iot" data-ribbon="Code @ GitHub"
    title="Code @ GitHub">Code @ GitHub</a>
  <header class="w3-container w3-theme w3-padding" style="margin-bottom: 20px;">
    <span><img src="android-icon-192x192.png" height="64px;"></span>
    <span class="w3-xlarge">IOT configurator</span>
  </header>
  <div id="app" style="max-width: 500px; margin: auto;">
    <div v-if="!browserSetup">
      Your browser is not supporting ...
    </div>
    <div v-else>
      <div v-if="!connection" style="text-align: center;">
        <div class="lds-ripple">
          <div></div>
          <div></div>
        </div><br />
        Waiting for a message from the complimentary program.<br />
        You don't need administrative permissions to run this program.<br />
        You can download it from the following link.<br />
        <a class="w3-btn w3-theme" target="_blank" href="https://github.com/chilipeppr/serial-port-json-server">Code</a>
        <a class="w3-btn w3-theme" target="_blank"
          href="https://github.com/chilipeppr/serial-port-json-server/releases">Releases</a>
      </div>
      <div v-else>
        <div class="w3-row">
          <div class="w3-col s1">
            <button class="w3-button w3-theme w3-border w3-border-theme smallIconButton w3-block"
              @click="refreshPorts"><i class="fas fa-sync-alt"></i></button>
          </div>
          <div class="w3-col" :class="validSelectedPort()? 's10' : 's11'">
            <select class="w3-select w3-input w3-border w3-border-theme" v-model="selectedPort">
              <option disabled>Click refresh to show the available devices</option>
              <option v-for="(item, index) in SerialPorts" :value="item.Name">{{item.Friendly}}</option>
            </select>
          </div>
          <div class="w3-col s1" v-if="validSelectedPort()">
            <button v-if="isOpen()" class="w3-button w3-border w3-border-theme w3-block smallIconButton w3-red"
              @click="disconnect"><i class="fas fa-times"></i></button>
            <button v-else class="w3-button w3-border w3-border-theme w3-block smallIconButton w3-green"
              @click="connect"><i class="fas fa-plug"></i></button>
          </div>
        </div>
        <div v-if="validSelectedPort()">
          <div class="w3-tooltip w3-small" style="background: rgb(218, 204, 231);">
            <i class="fas fa-info-circle"></i> Port info<span
              style="text-align: left; position:absolute;left:0;top:18px; background: rgb(218, 204, 231); color: black;; " class="w3-text w3-tag w3-block">
              Port: <b>{{sPortItem.Name}}</b><br />
              Friendly: <b>{{sPortItem.Friendly}}</b><br />
              Serial number: <b>{{sPortItem.SerialNumber}}</b><br />
              Device class: <b>{{sPortItem.DeviceClass}}</b><br />
              Is open: <b>{{sPortItem.IsOpen}}</b><br />
              Is primary: <b>{{sPortItem.IsPrimary}}</b><br />
              Related names: <b>{{sPortItem.RelatedNames}}</b><br />
              Baud: <b>{{sPortItem.Baud}}</b><br />
              Buffer algorithm: <b>{{sPortItem.BufferAlgorithm}}</b><br />
              USB Vendor ID: <b>{{sPortItem.UsbVid}}</b><br />
              USB Product ID: <b>{{sPortItem.UsbPid}}</b><br />
              Feedrate override: <b>{{sPortItem.FeedRateOverride}}</b><br />
            </span>
          </div>
        </div>
        <input v-model.number="temp">
        <button @click="send">Send</button>
      </div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/vue"></script>

  <script>
    var app = new Vue({
      el: "#app",
      data: {
        temp: 0.1,
        browserSetup: false,
        connection: null,
        SerialPorts: [],
        selectedPort: null,
        sPortItem: null,
        baudrate: 1500000
      },
      mounted: function () {
        if (window["WebSocket"]) {
          this.browserSetup = true;
        }

      },
      methods: {
        validSelectedPort: function () {
          for (var i = 0; i < this.SerialPorts.length; i++) {
            if (this.SerialPorts[i].Name === this.selectedPort) {
              this.sPortItem = this.SerialPorts[i];
              return true;
            }
          }
          return false;
        },
        isOpen: function () {
          return this.sPortItem.IsOpen;
        },
        refreshPorts: function () {
          conn.send("list");
        },
        connect: function () {
          conn.send("open " + this.sPortItem.Name + " "+ this.baudrate +" timed");
        },
        disconnect: function () {
          conn.send("close " + this.sPortItem.Name);
        },
        send: function () {
          conn.send("send com3 " + this.temp);
        }
      }
    });

    var conn;

    function checkThePlugin() {
      console.log("called");
      if (!conn) {
        console.log("entered");
        try {
          conn = new WebSocket("ws://localhost:8989/ws");
        } catch (e) {
          return;
        }
        conn.onclose = function (evt) {
          conn = null;
          app.$set(app.$data, 'connection', null);
        }
        conn.onmessage = function (evt) {
          console.log(evt.data);
          if (!!evt.data) {
            var recInfo;
            try {
              recInfo = JSON.parse(evt.data);
            } catch (e) {
              return;
            }
          }
          if (!!recInfo.Hostname) {
            app.$set(app.$data, 'connection', conn)
            conn.send("list");
          };
          if (!!recInfo.SerialPorts) {
            app.$set(app.$data, 'SerialPorts', JSON.parse(evt.data).SerialPorts);
          }
          if (!!recInfo.Cmd) {
            if (recInfo.Cmd === "Open" || recInfo.Cmd === "Close") {
              conn.send("list");
            }
            if (recInfo.Cmd === "OpenFail" || recInfo.Cmd === "CloseFail") {
            console.log("error: " + recInfo.Desc);
            }
          }
        }
      }
    }

    checkThePlugin();
    var pluginTestingInterval = setInterval(checkThePlugin, 3000);
  </script>

</body>

</html>
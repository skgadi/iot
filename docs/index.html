<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>A simple IOT example</title>

  <!--Faveicon handling-->
  <link rel="apple-touch-icon" sizes="57x57" href="apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192" href="android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
  <link rel="manifest" href="manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">

  <!--CSS help-->
  <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
  <link rel="stylesheet" href="https://www.w3schools.com/lib/w3-theme-indigo.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.css"
    integrity="sha256-46qynGAkLSFpVbEBog43gvNhfrOj+BmwXdxFgVK/Kvc=" crossorigin="anonymous" />
  <link rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/github-fork-ribbon-css/0.2.3/gh-fork-ribbon.min.css" />
  <!--Redirect to a correct page-->
  <script>
    if (window.location.hostname !== "github.skgadi.com" && window.location.hostname !== "localhost")
      window.location.href = "https://github.skgadi.com/iot/";
  </script>
  <style>
    .w3-input {
      outline-width: 0;
    }

    input[type="color"] {
      -webkit-appearance: none;
      border: none;
    }

    input[type="color"]::-webkit-color-swatch-wrapper {
      padding: 0;
    }

    input[type="color"]::-webkit-color-swatch {
      border: none;
    }
    table {
      margin: auto !important;
    }
  </style>
</head>

<body>
  <a class="github-fork-ribbon" href="https://github.com/skgadi/iot" data-ribbon="Code @ GitHub"
    title="Code @ GitHub">Code @ GitHub</a>
  <header class="w3-container w3-theme w3-padding" style="margin-bottom: 20px;">
    <span><img src="android-icon-192x192.png" height="64px;"></span>
    <span class="w3-xlarge">Simple IOT example</span>
  </header>
  <div id="app" class="w3-row">
    <div class="w3-col l4 m6 s12 w3-border w3-border-theme">
      <div class="w3-theme-d2">
        <div class="w3-padding w3-large">Connect device</div>
      </div>
      <div class="w3-padding">
        <label>Device ID</label>
        <div class="w3-row">
          <div class="w3-col s11">
            <input class="w3-input w3-border w3-border-theme" v-model="deviceID" type="text" :disabled="connected">
          </div>
          <div class="w3-col s1">
            <div href="#" @click="connect"
              class="w3-button w3-ripple w3-block  w3-hover-theme w3-border-theme w3-border"
              :class="connected ? 'w3-red': 'w3-green'" style="padding: 8px 0;">
              <div v-if="connected"><i class="fas fa-times"></i></div>
              <div v-else><i class="fas fa-check"></i></div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div v-show="connected && !deviceAvail" class="w3-col l4 m6 s12 w3-border w3-border-theme">
      <div class="w3-theme-d2">
        <div class="w3-padding w3-large">Device not available</div>
      </div>
      <div class="w3-padding">
        <div>The selected device is not available. Please make sure your id is correct.</div>
      </div>
    </div>
    <div v-show="connected && deviceAvail" class="w3-col l4 m6 s12 w3-border w3-border-theme">
      <div class="w3-theme-d2">
        <div class="w3-padding w3-large">LED color</div>
      </div>
      <div class="w3-padding">
        <label>Select color</label>
        <input class="w3-block" type="color" style="height: 40px;" v-model="LEDColor" @change="updateLEDsOnServer">
      </div>
    </div>
    <div v-show="connected && deviceAvail" class="w3-col l4 m6 s12 w3-border w3-border-theme">
      <div class="w3-theme-d2">
        <div class="w3-padding w3-large">Temperature</div>
      </div>
      <div class="w3-padding">
        <div class="w3-center"><div id="gauge_div"></div></div>
      </div>
    </div>

  </div>
  <script src="https://cdn.jsdelivr.net/npm/vue"></script>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <script>
    var app = new Vue({
      el: '#app',
      data: {
        fbData: {},
        deviceID: "FIME20190002",
        connected: false,
        LEDColor: "#ffffff",
        deviceAvail: false
      },
      watch: {},
      methods: {
        updateLEDsOnServer() {
          firebase.database().ref('Devices/' + this.deviceID + '/led').set(this.hexToRgb(this.LEDColor));
        },
        componentToHex: function (c) {
          var hex = c.toString(16);
          return hex.length == 1 ? "0" + hex : hex;
        },
        rgbToHex: function (led) {
          return "#" + this.componentToHex(led[0]) + this.componentToHex(led[1]) + this.componentToHex(led[2]);
        },
        hexToRgb: function (hex) {
          var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
          return result ? {
            0: parseInt(result[1], 16),
            1: parseInt(result[2], 16),
            2: parseInt(result[3], 16)
          } : null;
        },
        setLEDColor: function () {
          this.LEDColor = this.rgbToHex(this.fbData.led);
        },
        connect: function () {
          if (!!this.deviceID) {
            if (this.connected) {
              starCountRef.off();
              this.connected = false;
            } else {
              starCountRef = firebase.database().ref('Devices/' + this.deviceID)
              starCountRef.on('value', function (snapshot) {
                if (snapshot.exists()) {
                  app.$set(app.$data, "fbData", snapshot.val());
                  app.setLEDColor();
                  app.$set(app.$data, 'deviceAvail', true);
                  gaugeData.setValue(0, 0, app.$data.fbData.sensors.temp);
                  gauge.draw(gaugeData, gaugeOptions);
                } else {
                  app.$set(app.$data, 'deviceAvail', false);
                }
              });
              this.connected = true;
            }
          } else alert("Device ID cannot be blank");
        }
      }
    })
  </script>



  <script src="https://www.gstatic.com/firebasejs/7.1.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.1.0/firebase-analytics.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.1.0/firebase-database.js"></script>

  <script>
    var firebaseConfig = {
      apiKey: "AIzaSyAov9Y8GpIzNB3DIlPnd9Waydw2R1Z3_34",
      authDomain: "skgadi-basic-iot.firebaseapp.com",
      databaseURL: "https://skgadi-basic-iot.firebaseio.com",
      projectId: "skgadi-basic-iot",
      storageBucket: "skgadi-basic-iot.appspot.com",
      messagingSenderId: "318050979439",
      appId: "1:318050979439:web:a6d43b571973dbd9b7879a",
      measurementId: "G-JHFN5VCSKD"
    };
    firebase.initializeApp(firebaseConfig);
    firebase.analytics();
  </script>
  <script>
    var database = firebase.database();
    var starCountRef;
  </script>

<script type="text/javascript">
  google.charts.load('current', {'packages':['gauge']});
    google.charts.setOnLoadCallback(drawGauge);

    var gaugeOptions = {min: 0, max: 100, yellowFrom: 40, yellowTo: 50,
      redFrom: 50, redTo: 100, minorTicks: 5};
    var gauge;

    function drawGauge() {
      gaugeData = new google.visualization.DataTable();
      gaugeData.addColumn('number', 'Temperature');
      gaugeData.addRows(1);
      gaugeData.setCell(0, 0, 0);

      gauge = new google.visualization.Gauge(document.getElementById('gauge_div'));
      gauge.draw(gaugeData, gaugeOptions);
    }

</script>
</body>

</html>